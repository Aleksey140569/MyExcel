(()=>{"use strict";function t(t,e){return t>e&&([e,t]=[t,e]),new Array(e-t+1).fill("").map(((e,n)=>t+n))}function e(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e)return JSON.parse(localStorage.getItem(t));localStorage.setItem(t,JSON.stringify(e))}class n{constructor(t){this.store=t,this.sub=null,this.prevState={}}subscribeComponents(t){this.prevState=this.store.getState(),this.sub=this.store.subscribe((e=>{Object.keys(e).forEach((n=>{var r,i;r=this.prevState[n],i=e[n],("object"==typeof r&&"object"==typeof i?JSON.stringify(r)===JSON.stringify(i):r===i)||t.forEach((t=>{if(t.isWatching(n)){const r={[n]:e[n]};t.storeChanged(r)}}))})),this.prevState=this.store.getState()}))}unsubscribeFromStore(){this.sub.unsubscribe()}}class r{constructor(t){this.$el="string"==typeof t?document.querySelector(t):t}html(t){return"string"==typeof t?(this.$el.innerHTML=t,this):this.$el.outerHTML.trim()}text(t){return"string"==typeof t?(this.$el.textContent=t,this):"input"===this.$el.tagName.toLowerCase()?this.$el.value.trim():this.$el.textContent.trim()}clear(){return this.html(""),this}on(t,e){this.$el.addEventListener(t,e)}off(t,e){this.$el.removeEventListener(t,e)}find(t){return i(this.$el.querySelector(t))}append(t){return t instanceof r&&(t=t.$el),Element.prototype.append?this.$el.append(t):this.$el.appendChild(t),this}get data(){return this.$el.dataset}closest(t){return i(this.$el.closest(t))}getCoords(){return this.$el.getBoundingClientRect()}findAll(t){return this.$el.querySelectorAll(t)}css(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object.keys(t).forEach((e=>{this.$el.style[e]=t[e]}))}id(t){if(t){const t=this.id().split(":");return{row:+t[0],col:+t[1]}}return this.data.id}focus(){return this.$el.focus(),this}addClass(t){return this.$el.classList.add(t),this}removeClass(t){return this.$el.classList.remove(t),this}}function i(t){return new r(t)}i.create=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const n=document.createElement(t);return e&&n.classList.add(e),i(n)};class s{constructor(){this.listeners={}}emit(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return!!Array.isArray(this.listeners[t])&&(this.listeners[t].forEach((t=>{t(...n)})),!0)}subscribe(t,e){return this.listeners[t]=this.listeners[t]||[],this.listeners[t].push(e),()=>{this.listeners[t]=this.listeners[t].filter((t=>t!==e))}}}class o{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(!t)throw new Error("No $root provided for DomListener!");this.$root=t,this.listeners=e}initDOMListeners(){this.listeners.forEach((t=>{const e=a(t);if(!this[e]){const t=this.name||"";throw new Error("Method ".concat(e," is not implemented in ").concat(t," Component!"))}this[e]=this[e].bind(this),this.$root.on(t,this[e])}))}removeDOMListeners(){this.listeners.forEach((t=>{const e=a(t);this.$root.off(t,this[e])}))}}function a(t){return"on"+("string"!=typeof(e=t)?"":e.charAt(0).toUpperCase()+e.slice(1));var e}class c extends o{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(t,e.listeners),this.name=e.name||"",this.emitter=e.emitter,this.subscribe=e.subscribe||[],this.store=e.store,this.unsubscribers=[],this.prepare()}prepare(){}toHTML(){return""}$emit(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];this.emitter.emit(t,...n)}$on(t,e){const n=this.emitter.subscribe(t,e);this.unsubscribers.push(n)}$dispatch(t){this.store.dispatch(t)}storeChanged(){}isWatching(t){return this.subscribe.includes(t)}init(){this.initDOMListeners()}destroy(){this.removeDOMListeners(),this.unsubscribers.forEach((t=>t()))}}class l extends c{constructor(t,e){super(t,{name:"Header",...e})}toHTML(){return'\n      <input type="text" class="input" value="Новая таблица">\n      <div>\n        <div class="button">\n          <span class="material-icons">\n            delete\n          </span>\n        </div>\n        <div class="button">\n          <span class="material-icons">\n            exit_to_app\n          </span>\n        </div>\n      </div>\n    '}}var u,h,d,f;function p(t){const e='data-type="button"\n    data-value=\''.concat(JSON.stringify(t.value),"'");return'\n    <div\n      class="button '.concat(t.active?"active":"",'"\n        ').concat(e,'\n    >\n      <span class="material-icons"\n        ').concat(e,"\n      >\n        ").concat(t.incon,"\n      </span>\n    </div>\n  ")}u=l,d="excel__header",(h="symbol"==typeof(f=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(h="className"))?f:String(f))in u?Object.defineProperty(u,h,{value:d,enumerable:!0,configurable:!0,writable:!0}):u[h]=d;class m extends c{constructor(){super(...arguments)}get template(){return JSON.stringify(this.state,null,2)}initState(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.state={...t}}setState(t){this.state={...this.state,...t},this.$root.html(this.template)}}class v extends m{constructor(t,e){super(t,{name:"Toolbar",listeners:["click"],...e})}prepare(){this.initState({textAlig:"left",fontWeight:"normal",textDecoration:"none",fontStyle:"normal"})}get template(){return[{incon:"format_align_left",active:"left"===(t=this.state).textAlig,value:{textAlig:"left"}},{incon:"format_align_center",active:"center"===t.textAlig,value:{textAlig:"center"}},{incon:"format_align_right",active:"right"===t.textAlig,value:{textAlig:"right"}},{incon:"format_bold",active:"bold"===t.fontWeight,value:{fontWeight:"bold"===t.fontWeight?"normal":"bold"}},{incon:"format_italic",active:"italic"===t.fontStyle,value:{fontStyle:"italic"===t.fontStyle?"normal":"italic"}},{incon:"format_underlined",active:"underline"===t.textDecoration,value:{textDecoration:"underline"===t.textDecoration?"none":"underline"}}].map(p).join("");var t}toHTML(){return this.template}onClick(t){const e=i(t.target);if("button"===e.data.type){const t=JSON.parse(e.data.value),n=Object.keys(t)[0];this.setState({[n]:t[n]})}}}!function(t,e,n){e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(e),e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n}(v,"className","excel__toolbar");class b extends c{constructor(t,e){super(t,{name:"Formula",listeners:["input","keydown"],subscribe:["currentText"],...e})}toHTML(){return'\n      <div class="info">\n        fx\n      </div>\n      <div id="formula" class="input" contenteditable spellcheck="false"></div>\n    '}init(){super.init(),this.$formula=this.$root.find("#formula"),this.$on("table:select",(t=>{this.$formula.text(t.text())}))}storeChanged(t){let{currentText:e}=t;this.$formula.text(e)}onInput(t){this.$emit("formula:input",i(t.target).text())}onKeydown(t){["Enter","Tab"].includes(t.key)&&(t.preventDefault(),this.$emit("formula:done"))}}!function(t,e,n){e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(e),e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n}(b,"className","excel__formula");const g={A:65,Z:90},y=120,w=24;function S(t,e){return(t[e]||y)+"px"}function x(t,e){return function(n,r){const i="".concat(e,":").concat(r),s=S(t.colState,r),o=t.dataState[i];return'\n      <div \n        class="cell" \n        contenteditable \n        data-col="'.concat(r,'"\n        data-type="cell"\n        data-id="').concat(i,'"\n        style="width: ').concat(s,'"\n      >\n        ').concat(o||"","\n      </div>\n    ")}}function $(t){let{col:e,index:n,width:r}=t;return'\n    <div \n      class="column" \n      data-type="resizable" \n      data-col="'.concat(n,'" \n      style="width: ').concat(r,'"\n    >\n      ').concat(e,'\n      <div class="col-resize" data-resize="col"></div>\n    </div>\n  ')}function E(t,e){const n=t?'<div class="row-resize" data-resize="row"></div>':"",r=function(t,e){return(t[e]||w)+"px"}(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},t);return'\n    <div \n      class="row" \n      data-type="resizable" \n      data-row="'.concat(t,'"\n      style="height: ').concat(r,'"\n    >\n      <div class="row-info">\n        ').concat(t||"","\n        ").concat(n,'\n      </div>\n      <div class="row-data">\n        ').concat(e,"\n      </div>\n    </div>\n  ")}function A(t,e){return String.fromCharCode(g.A+e)}class T{constructor(){this.group=[],this.current=null}select(t){this.clear(),t.focus().addClass(T.className),this.group.push(t),this.current=t}clear(){this.group.forEach((t=>t.removeClass(T.className))),this.group=[]}selectGroup(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.clear(),this.group=t,this.group.forEach((t=>t.addClass(T.className)))}}!function(t,e,n){e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(e),e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n}(T,"className","selected");const C="TABLE_RESIZE",_="CHANGE_TEXT";class j extends c{constructor(t,e){super(t,{name:"Table",listeners:["mousedown","keydown","input"],...e})}toHTML(){return function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=g.Z-g.A+1,r=[],i=new Array(n).fill("").map(A).map(function(t){return function(e,n){return{col:e,index:n,width:S(t.colState,n)}}}(e)).map($).join("");r.push(E(null,i));for(let i=0;i<t;i++){const t=new Array(n).fill("").map(x(e,i)).join("");r.push(E(i+1,t,e.rowState))}return r.join("")}(45,this.store.getState())}prepare(){this.selection=new T}init(){super.init(),this.selectCell(this.$root.find('[data-id="0:0"]')),this.$on("formula:input",(t=>{this.selection.current.text(t),this.updateTextInStore(t)})),this.$on("formula:done",(()=>{this.selection.current.focus()}))}selectCell(t){this.selection.select(t),this.$emit("table:select",t)}async resizeTable(t){try{const e=await function(t,e){return new Promise((n=>{const r=i(e.target),s=r.closest('[data-type="resizable"]'),o=s.getCoords(),a=r.data.resize,c="col"===a?"bottom":"right";let l;r.css({[c]:"-5000px",opacity:1}),t.findAll('[data-col="'.concat(s.data.col,'"]')),document.onmousemove=t=>{if("col"===a){const e=Math.floor(t.pageX-o.right);l=o.width+e,r.css({right:-e+"px"})}else{const e=Math.floor(t.pageY-o.bottom);l=o.height+e,r.css({bottom:-e+"px"})}},document.onmouseup=e=>{document.onmousemove=null,document.onmouseup=null,"col"===a?(s.css({width:l+"px"}),t.findAll('[data-col="'.concat(s.data.col,'"]')).forEach((t=>t.style.width=l+"px"))):s.css({height:l+"px"}),n({value:l,type:a,id:s.data[a]}),r.css({bottom:0,opacity:0,right:0})}}))}(this.$root,t);this.$dispatch(function(t){return{type:C,data:t}}(e))}catch(t){console.warn("Resize error: ",t.message)}}onMousedown(e){if(function(t){return t.target.dataset.resize}(e))this.resizeTable(e);else if(function(t){return"cell"===t.target.dataset.type}(e)){const n=i(e.target);if(e.shiftKey){const e=function(e,n){const r=e.id(!0),i=n.id(!0),s=t(i.col,r.col),o=t(i.row,r.row);return s.reduce(((t,e)=>(o.forEach((n=>t.push("".concat(n,":").concat(e)))),t)),[])}(n,this.selection.current).map((t=>this.$root.find('[data-id="'.concat(t,'"]'))));this.selection.selectGroup(e)}else this.selectCell(n)}}onKeydown(t){const{key:e}=t;if(["Enter","Tab","ArrowLeft","ArrowRight","ArrowDown","ArrowUp"].includes(e)&&!t.shiftKey){t.preventDefault();const n=this.selection.current.id(!0),r=this.$root.find(function(t,e){let{col:n,row:r}=e;switch(t){case"Enter":case"ArrowDown":r++;break;case"Tab":case"ArrowRight":n++;break;case"ArrowLeft":n=n-1<0?0:n-1;break;case"ArrowUp":r=r-1<0?0:r-1}return'[data-id="'.concat(r,":").concat(n,'"]')}(e,n));this.selectCell(r)}}updateTextInStore(t){var e;this.$dispatch((e={id:this.selection.current.id(),value:t},{type:_,data:e}))}onInput(t){this.updateTextInStore(i(t.target).text())}}!function(t,e,n){e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(e),e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n}(j,"className","excel__table");const L=function(t){let e=t({...arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}},{type:"__INIT__"}),n=[];return{subscribe:t=>(n.push(t),{unsubscribe(){n=n.filter((e=>e!==t))}}),dispatch(r){e=t(e,r),n.forEach((t=>t(e)))},getState:()=>JSON.parse(JSON.stringify(e))}}((function(t,e){let n,r;switch(e.type){case C:return r="col"===e.data.type?"colState":"rowState",n=t[r]||{},n[e.data.id]=e.data.value,{...t,[r]:n};case _:return n=t.dataState||{},n[e.data.id]=e.data.value,{...t,currentText:e.data.value,dataState:n};default:return t}}),e("excel-state")?e("excel-state"):{rowState:{},colState:{},dataState:{},currentText:""});L.subscribe((t=>{e("excel-state",t)})),new class{constructor(t,e){this.$el=i(t),this.components=e.components||[],this.store=e.store,this.emitter=new s,this.subscriber=new n(this.store)}getRoot(){const t=i.create("div","excel"),e={emitter:this.emitter,store:this.store};return this.components=this.components.map((n=>{const r=i.create("div",n.className),s=new n(r,e);return r.html(s.toHTML()),t.append(r),s})),t}render(){this.$el.append(this.getRoot()),this.subscriber.subscribeComponents(this.components),this.components.forEach((t=>t.init()))}destroy(){this.subscriber.unsubscribeFromStore(),this.components.forEach((t=>t.destroy()))}}("#app",{components:[l,v,b,j],store:L}).render()})();